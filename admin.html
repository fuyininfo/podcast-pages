<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Pages ç®¡ç†æ§åˆ¶å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root { --primary: #2ea44f; --bg: #f6f8fa; --border: #d1d5da; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: var(--bg); color: #24292e; }
        .card { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h1 { border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        h2 { font-size: 1.2em; margin-top: 0; color: #0366d6; }
        label { display: block; margin: 10px 0 5px; font-weight: 600; font-size: 0.9em; }
        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #fafbfc; color: #24292e; border: 1px solid rgba(27,31,35,0.15); }
        .hidden { display: none; }
        .status { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        .success { background: #dcffe4; color: #1a7f37; }
        .error { background: #ffe3e6; color: #cf222e; }
        .step-guide { background: #e1f5fe; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #03a9f4; }
        .preview-box { background: #f1f8ff; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85em; margin-top: 5px; color: #444; }
    </style>
</head>
<body>

    <h1>ğŸ™ï¸ Podcast Pages æœ¬åœ°ç®¡ç†å™¨</h1>

    <div id="step-connect" class="card">
        <h2>1. è¿æ¥é¡¹ç›®æ–‡ä»¶å¤¹</h2>
        <p>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œé€‰æ‹©æœ¬åœ°çš„ <code>podcast-pages</code> æ–‡ä»¶å¤¹ã€‚æµè§ˆå™¨ä¼šè¯·æ±‚è¯»å†™æƒé™ï¼Œè¯·ç‚¹å‡»â€œå…è®¸â€ã€‚</p>
        <button onclick="selectDirectory()">ğŸ“‚ æ‰“å¼€é¡¹ç›®æ–‡ä»¶å¤¹</button>
        <p id="dir-status" class="status hidden"></p>
    </div>

    <div id="main-interface" class="hidden">
        
        <div class="card">
            <h2>2. ç½‘ç«™åŸºç¡€è®¾ç½® (_config.yml)</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>æ’­å®¢åç§° (Title)</label>
                    <input type="text" id="cfg-title">
                </div>
                <div>
                    <label>GitHub Pages é“¾æ¥ (URL)</label>
                    <input type="text" id="cfg-url" placeholder="https://username.github.io">
                </div>
            </div>
            <label>æ’­å®¢æè¿° (Description)</label>
            <textarea id="cfg-desc" rows="3"></textarea>
            <div style="margin-top:10px;">
                <button class="secondary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <span id="cfg-msg" style="margin-left: 10px; font-size: 0.8em;"></span>
            </div>
        </div>

        <div class="card">
            <h2>3. å‘å¸ƒæ–°èŠ‚ç›®</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>èŠ‚ç›®æ ‡é¢˜ (Title)</label>
                    <input type="text" id="ep-title" placeholder="ä¾‹å¦‚ï¼šç¬¬01æœŸ - æˆ‘ä»¬çš„å¼€å§‹">
                </div>
                <div>
                    <label>å‘å¸ƒæ—¥æœŸ</label>
                    <input type="date" id="ep-date">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>æ—¶é•¿ (Duration)</label>
                    <input type="text" id="ep-duration" placeholder="MM:SS (å¦‚ 45:20)">
                </div>
                <div>
                    <label>å†…å®¹åˆ†çº§ (Explicit)</label>
                    <select id="ep-explicit">
                        <option value="no">No (å…¨å¹´é¾„)</option>
                        <option value="yes">Yes (é™åˆ¶çº§)</option>
                    </select>
                </div>
            </div>

            <label>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ (.mp3)</label>
            <input type="file" id="ep-file" accept=".mp3">

            <label>èŠ‚ç›®ç®€ä»‹ (Description)</label>
            <textarea id="ep-desc" rows="5" placeholder="æœ¬æœŸèŠ‚ç›®çš„è¯¦ç»†ä»‹ç»..."></textarea>

            <div class="preview-box">
                <div>éŸ³é¢‘å°†é‡å‘½åä¸º: <span id="preview-audio">-</span></div>
                <div>æ–‡ä»¶å°†åˆ›å»ºä¸º: <span id="preview-post">-</span></div>
            </div>

            <div style="margin-top: 15px;">
                <button onclick="createEpisode()">ğŸš€ ç”ŸæˆèŠ‚ç›®æ–‡ä»¶</button>
            </div>
            <div id="ep-msg" class="status hidden"></div>
        </div>

        <div class="step-guide">
            <h2>4. æœ€åä¸€æ­¥ï¼šä¸Šä¼ åˆ° GitHub</h2>
            <ol>
                <li>æ‰“å¼€ <strong>GitHub Desktop</strong> è½¯ä»¶ã€‚</li>
                <li>ä½ ä¼šçœ‹åˆ° Changes åˆ—è¡¨é‡Œå‡ºç°äº†æ–°çš„ <code>.mp3</code> å’Œ <code>.md</code> æ–‡ä»¶ã€‚</li>
                <li>åœ¨å·¦ä¸‹è§’ Summary æ¡†è¾“å…¥ï¼š<strong>å‘å¸ƒæ–°èŠ‚ç›®</strong>ã€‚</li>
                <li>ç‚¹å‡»è“è‰²æŒ‰é’® <strong>Commit to master</strong>ã€‚</li>
                <li>ç‚¹å‡»é¡¶éƒ¨æŒ‰é’® <strong>Push origin</strong>ã€‚</li>
            </ol>
        </div>
    </div>

<script>
    let dirHandle;
    const { pinyin } = pinyinPro; // åˆå§‹åŒ–æ‹¼éŸ³åº“

    // ç›‘å¬è¾“å…¥ä»¥æ›´æ–°é¢„è§ˆ
    document.getElementById('ep-title').addEventListener('input', updatePreview);
    document.getElementById('ep-date').addEventListener('change', updatePreview);
    document.getElementById('ep-file').addEventListener('change', updatePreview);

    function toPinyinString(str, separator = '') {
        // ä½¿ç”¨ pinyin-pro å°†æ±‰å­—è½¬ä¸ºæ— å£°è°ƒæ‹¼éŸ³ï¼Œéæ±‰å­—éƒ¨åˆ†ä¿ç•™
        // type: 'array' è¿”å›æ•°ç»„ï¼ŒtoneType: 'none' å»å£°è°ƒ
        const pinyinArr = pinyin(str, { toneType: 'none', type: 'array', nonZh: 'consecutive' });
        // è¿‡æ»¤æ‰ç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯ã€æ•°å­—
        const cleanArr = pinyinArr.map(item => item.replace(/[^a-zA-Z0-9]/g, '').toLowerCase());
        // è¿‡æ»¤ç©ºå­—ç¬¦ä¸²å¹¶è¿æ¥
        return cleanArr.filter(i => i).join(separator);
    }

    function updatePreview() {
        const title = document.getElementById('ep-title').value || 'untitled';
        const dateVal = document.getElementById('ep-date').value || '2025-01-01';
        const fileInput = document.getElementById('ep-file');
        
        let audioName = "æœªé€‰æ‹©æ–‡ä»¶";
        if (fileInput.files.length > 0) {
            const originalName = fileInput.files[0].name.replace(/\.mp3$/i, '');
            // éŸ³é¢‘æ–‡ä»¶åï¼šæ‹¼éŸ³è¿å†™ï¼Œæ— ç©ºæ ¼
            audioName = toPinyinString(originalName, '') + ".mp3";
        }

        // å¸–å­æ–‡ä»¶åï¼šæ—¥æœŸ-æ‹¼éŸ³æ ‡é¢˜ (ç”¨çŸ­æ¨ªçº¿åˆ†éš”)
        const postName = `${dateVal}-${toPinyinString(title, '-')}.md`;

        document.getElementById('preview-audio').innerText = audioName;
        document.getElementById('preview-post').innerText = `_posts/${postName}`;
        
        return { audioName, postName };
    }

    // 1. é€‰æ‹©å¹¶éªŒè¯ç›®å½•
    async function selectDirectory() {
        try {
            dirHandle = await window.showDirectoryPicker();
            try {
                await dirHandle.getFileHandle('_config.yml');
            } catch (e) {
                alert("é”™è¯¯ï¼šè¿™ä¸æ˜¯ podcast-pages é¡¹ç›®æ–‡ä»¶å¤¹ï¼ˆæ‰¾ä¸åˆ° _config.ymlï¼‰ã€‚");
                return;
            }
            document.getElementById('step-connect').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('ep-date').valueAsDate = new Date();
            loadConfig();
        } catch (err) {
            console.error(err);
        }
    }

    // 2. è¯»å–é…ç½®
    async function loadConfig() {
        try {
            const fileHandle = await dirHandle.getFileHandle('_config.yml');
            const file = await fileHandle.getFile();
            const text = await file.text();
            const config = jsyaml.load(text);
            document.getElementById('cfg-title').value = config.title || '';
            document.getElementById('cfg-url').value = config.url || '';
            document.getElementById('cfg-desc').value = config.description || '';
        } catch (e) { console.error(e); }
    }

    // 3. ä¿å­˜é…ç½®
    async function saveConfig() {
        try {
            const fileHandle = await dirHandle.getFileHandle('_config.yml', { create: false });
            const file = await fileHandle.getFile();
            const text = await file.text();
            let config = jsyaml.load(text) || {};
            config.title = document.getElementById('cfg-title').value;
            config.url = document.getElementById('cfg-url').value;
            config.description = document.getElementById('cfg-desc').value;
            const writable = await fileHandle.createWritable();
            await writable.write(jsyaml.dump(config));
            await writable.close();
            const msg = document.getElementById('cfg-msg');
            msg.innerText = "å·²ä¿å­˜!";
            msg.style.color = "green";
            setTimeout(() => msg.innerText = "", 2000);
        } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
    }

    // 4. åˆ›å»ºèŠ‚ç›®
    async function createEpisode() {
        const title = document.getElementById('ep-title').value;
        const fileInput = document.getElementById('ep-file');
        const desc = document.getElementById('ep-desc').value;
        const duration = document.getElementById('ep-duration').value;
        const explicit = document.getElementById('ep-explicit').value;
        const msgDiv = document.getElementById('ep-msg');

        if (!title || fileInput.files.length === 0) {
            alert("è¯·å¡«å†™æ ‡é¢˜å¹¶é€‰æ‹© MP3 æ–‡ä»¶");
            return;
        }

        msgDiv.innerText = "æ­£åœ¨å¤„ç†...";
        msgDiv.className = "status";
        msgDiv.classList.remove('hidden');

        try {
            const audioFile = fileInput.files[0];
            const { audioName, postName } = updatePreview(); // è·å–è®¡ç®—å¥½çš„æ‹¼éŸ³æ–‡ä»¶å

            // --- A. ä¿å­˜éŸ³é¢‘æ–‡ä»¶ ---
            const assetsDir = await dirHandle.getDirectoryHandle('assets', { create: true });
            const audioDir = await assetsDir.getDirectoryHandle('audio', { create: true });
            
            const newAudioHandle = await audioDir.getFileHandle(audioName, { create: true });
            const writableAudio = await newAudioHandle.createWritable();
            await writableAudio.write(audioFile);
            await writableAudio.close();

            // --- B. ç”Ÿæˆ Markdown æ–‡ä»¶ ---
            const postsDir = await dirHandle.getDirectoryHandle('_posts', { create: true });
            
            const fileSize = audioFile.size;
            const now = new Date();
            const dateVal = document.getElementById('ep-date').value;
            const timeStr = now.toTimeString().split(' ')[0];
            const fullDate = `${dateVal} ${timeStr}`;

            const mdContent = `---
layout: post
title: "${title}"
date: ${fullDate} -0000
file: /assets/audio/${audioName}
summary: "${desc.substring(0, 100).replace(/\n/g, ' ').replace(/"/g, '\\"')}"
description: "${desc.replace(/"/g, '\\"')}"
duration: "${duration}"
length: "${fileSize}"
explicit: "${explicit}"
keywords: ""
block: "no"
voices: ""
---

${desc}
`;
            
            const newPostHandle = await postsDir.getFileHandle(postName, { create: true });
            const writablePost = await newPostHandle.createWritable();
            await writablePost.write(mdContent);
            await writablePost.close();

            msgDiv.innerHTML = `<strong>âœ… æˆåŠŸï¼</strong><br>1. éŸ³é¢‘å·²é‡å‘½åå¹¶ä¿å­˜: <code>assets/audio/${audioName}</code><br>2. é¡µé¢æ–‡ä»¶å·²åˆ›å»º: <code>_posts/${postName}</code><br>è¯·æ‰“å¼€ GitHub Desktop æäº¤æ›´æ”¹ã€‚`;
            msgDiv.className = "status success";

        } catch (e) {
            console.error(e);
            msgDiv.innerText = "å‘ç”Ÿé”™è¯¯: " + e.message;
            msgDiv.className = "status error";
        }
    }
</script>
</body>
</html>