<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Pages ç®¡ç†æ§åˆ¶å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root { --primary: #2ea44f; --bg: #f6f8fa; --border: #d1d5da; --text: #24292e; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        /* å¸ƒå±€ç»„ä»¶ */
        .header { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: start; }
        
        /* å“åº”å¼ï¼šå°å±å¹•å˜å•æ  */
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .side-column { order: -1; } /* æ‰‹æœºä¸Šè®©ä¾§è¾¹æ æ˜¾ç¤ºåœ¨ä¸Šé¢ */
        }

        .container { display: grid; gap: 20px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none; }
        
        /* æ ‡é¢˜ä¸æ–‡æœ¬ */
        h1 { margin: 0; }
        h2 { font-size: 1.2em; margin-top: 0; color: #0366d6; display: flex; align-items: center; justify-content: space-between; }
        h3 { font-size: 1em; margin: 0 0 10px 0; color: #586069; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        label { display: block; margin: 12px 0 6px; font-weight: 600; font-size: 0.9em; }
        p.hint { font-size: 0.85em; color: #586069; margin: 5px 0; }
        a { color: #0366d6; text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* è¡¨å•å…ƒç´  */
        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea.code-editor { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 13px; background: #f6f8fa; min-height: 200px; }
        
        /* æŒ‰é’® */
        button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #f3f4f6; color: #24292e; border: 1px solid rgba(27,31,35,0.15); }
        button.secondary:hover { background-color: #edeff2; }
        button.small { padding: 5px 10px; font-size: 12px; }

        /* çŠ¶æ€æç¤º */
        .status { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        .success { background: #dcffe4; color: #1a7f37; border: 1px solid #b4eebf; }
        .error { background: #ffe3e6; color: #cf222e; border: 1px solid #ffb3b8; }
        .info-box { background: #e1f5fe; padding: 15px; border-radius: 6px; border-left: 4px solid #03a9f4; margin-bottom: 20px; }
        
        /* é¢„è§ˆåŒºåŸŸ */
        .preview-box { background: #f1f8ff; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85em; margin-top: 5px; color: #444; border: 1px solid #c8e1ff; }
        .rss-link-box { background: #fffbdd; padding: 10px; border: 1px solid #fff5b1; border-radius: 4px; font-weight: bold; word-break: break-all; margin-top: 5px; color: #735c0f; }

        /* ä¾§è¾¹æ æ ·å¼ */
        .logo-preview { width: 100%; max-width: 150px; display: block; margin: 10px auto; border-radius: 6px; border: 1px solid #eee; }
        .episode-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .episode-list li { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .episode-list li:last-child { border-bottom: none; }
        .episode-date { color: #586069; font-size: 0.85em; display: block; margin-bottom: 2px; }
        .episode-title { font-weight: 600; color: #24292e; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ™ï¸ Podcast Pages æœ¬åœ°ç®¡ç†å™¨</h1>
    </div>

    <div id="step-connect" class="card">
        <h2>ğŸ“‚ ç¬¬ä¸€æ­¥ï¼šè¿æ¥é¡¹ç›®</h2>
        <p>è¯·ç‚¹å‡»æŒ‰é’®é€‰æ‹©æœ¬åœ°çš„ <code>podcast-pages</code> æ–‡ä»¶å¤¹ã€‚</p>
        <button onclick="selectDirectory()">æ‰“å¼€é¡¹ç›®æ–‡ä»¶å¤¹</button>
        <p id="dir-status" class="status hidden"></p>
    </div>

    <div id="main-interface" class="main-layout hidden">
        
        <div class="main-column">
            
            <div class="card">
                <h2>âš™ï¸ ç½‘ç«™åŸºç¡€è®¾ç½®</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>æ’­å®¢åç§° (Title)</label>
                        <input type="text" id="cfg-title" oninput="updateRSSUrlDisplay()">
                    </div>
                    <div>
                        <label>GitHub Pages é“¾æ¥ (URL)</label>
                        <input type="text" id="cfg-url" placeholder="https://username.github.io" oninput="updateRSSUrlDisplay()">
                    </div>
                </div>
                <div>
                    <label>ä»“åº“åç§° (Baseurl)</label>
                    <input type="text" id="cfg-baseurl" placeholder="/podcast-pages" oninput="updateRSSUrlDisplay()">
                    <p class="hint">å¦‚æœæ˜¯æ ¹åŸŸååˆ™ç•™ç©ºï¼Œå¦åˆ™ä»¥ / å¼€å¤´ï¼Œä¾‹å¦‚ <code>/podcast-pages</code></p>
                </div>
                <label>æ’­å®¢æè¿°</label>
                <textarea id="cfg-desc" rows="2"></textarea>
                <div style="margin-top:10px;">
                    <button class="secondary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <span id="cfg-msg" style="margin-left: 10px; font-size: 0.8em;"></span>
                </div>
            </div>

            <div class="card" style="border-left: 4px solid var(--primary);">
                <h2>ğŸ†• å‘å¸ƒæ–°èŠ‚ç›®</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>èŠ‚ç›®æ ‡é¢˜</label>
                        <input type="text" id="ep-title" placeholder="ä¾‹å¦‚ï¼šç¬¬01æœŸ - èŠèŠæŠ€æœ¯">
                    </div>
                    <div>
                        <label>å‘å¸ƒæ—¥æœŸ</label>
                        <input type="date" id="ep-date">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>æ—¶é•¿</label>
                        <input type="text" id="ep-duration" placeholder="MM:SS (å¦‚ 45:20)">
                    </div>
                    <div>
                        <label>å†…å®¹åˆ†çº§</label>
                        <select id="ep-explicit">
                            <option value="no">No (å…¨å¹´é¾„)</option>
                            <option value="yes">Yes (é™åˆ¶çº§)</option>
                        </select>
                    </div>
                </div>

                <label>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ (.mp3)</label>
                <input type="file" id="ep-file" accept=".mp3">

                <label>èŠ‚ç›®ç®€ä»‹</label>
                <textarea id="ep-desc" rows="4" placeholder="æœ¬æœŸèŠ‚ç›®çš„è¯¦ç»†ä»‹ç»..."></textarea>

                <div class="preview-box">
                    <div>ğŸµ éŸ³é¢‘: <span id="preview-audio">-</span></div>
                    <div>ğŸ“„ é¡µé¢: <span id="preview-post">-</span></div>
                </div>

                <div style="margin-top: 15px;">
                    <button onclick="createEpisode()">ğŸš€ ç”ŸæˆèŠ‚ç›®æ–‡ä»¶ (å¼ºåˆ¶å†™å…¥æ’­æ”¾å™¨)</button>
                </div>
                <div id="ep-msg" class="status hidden"></div>
            </div>

            <div class="card">
                <h2>
                    <span>ğŸ“¡ RSS ä¸ åˆ†ç±»è®¾ç½®</span>
                    <a href="https://podcasters.apple.com/support/1691-apple-podcasts-categories" target="_blank" style="font-size: 0.7em; font-weight: normal;">ğŸ”— åˆ†ç±»è¡¨</a>
                </h2>
                <p class="hint">ä¸¥æ ¼ä¿ç•™ XML æ ¼å¼ï¼Œä¿®æ”¹ <code>&lt;itunes:category&gt;</code>ã€‚</p>
                <textarea id="rss-editor" class="code-editor" spellcheck="false"></textarea>
                <div style="margin-top: 10px;">
                    <button class="secondary" onclick="saveRSS()">ğŸ’¾ ä¿å­˜ RSS è®¾ç½®</button>
                    <span id="rss-msg" style="margin-left: 10px; font-size: 0.8em;"></span>
                </div>
                <div style="margin-top: 15px;">
                    <label>RSS è®¢é˜…é“¾æ¥:</label>
                    <div id="final-rss-url" class="rss-link-box">...</div>
                </div>
            </div>
            
            <div class="info-box">
                <h2>ğŸ“¤ åŒæ­¥æŒ‡å—</h2>
                <p>æ–‡ä»¶ç”Ÿæˆåï¼Œè¯·æ‰“å¼€ <strong>GitHub Desktop</strong>ï¼š</p>
                <ol>
                    <li>æ£€æŸ¥å·¦ä¾§ Changes åˆ—è¡¨ï¼Œç¡®è®¤æœ‰æ–°çš„ <code>.mp3</code> å’Œ <code>.md</code> æ–‡ä»¶ã€‚</li>
                <li>åœ¨ Summary æ¡†è¾“å…¥å¤‡æ³¨ï¼ˆå¦‚â€œå‘å¸ƒæ–°èŠ‚ç›®â€ï¼‰ã€‚</li>
                <li>ç‚¹å‡» <strong>Commit to master</strong>ã€‚</li>
                <li>ç‚¹å‡»é¡¶éƒ¨ <strong>Push origin</strong>ã€‚</li>
                <li>ç­‰å¾… 1-2 åˆ†é’Ÿï¼ŒRSS å³å¯è‡ªåŠ¨æ›´æ–°ã€‚</li>
                </ol>
            </div>
        </div>

        <div class="side-column">
            
            <div class="card" style="text-align: center;">
                <h3>ğŸ–¼ï¸ æ’­å®¢ Logo</h3>
                <img id="current-logo" src="" alt="æš‚æ—  Logo" class="logo-preview">
                <input type="file" id="logo-upload" accept="image/png, image/jpeg" style="display: none;" onchange="handleLogoUpload()">
                <button class="secondary small" onclick="document.getElementById('logo-upload').click()">ğŸ“‚ æ›´æ¢ Logo</button>
                <p class="hint">å»ºè®® 1400x1400 åƒç´ ï¼Œpng/jpg</p>
            </div>

            <div class="card">
                <h3>ğŸ“‹ å·²å‘å¸ƒèŠ‚ç›®</h3>
                <ul id="episode-list" class="episode-list">
                    <li style="text-align: center; color: #999;">æ­£åœ¨åŠ è½½...</li>
                </ul>
                <div style="margin-top: 10px; text-align: center;">
                    <button class="secondary small" onclick="loadEpisodes()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>
            </div>

        </div>
    </div>

<script>
    let dirHandle;
    const { pinyin } = pinyinPro;

    // --- ç•Œé¢äº¤äº’é€»è¾‘ ---
    
    document.getElementById('ep-title').addEventListener('input', updatePreview);
    document.getElementById('ep-date').addEventListener('change', updatePreview);
    document.getElementById('ep-file').addEventListener('change', updatePreview);

    function toPinyinString(str, separator = '') {
        const pinyinArr = pinyin(str, { toneType: 'none', type: 'array', nonZh: 'consecutive' });
        const cleanArr = pinyinArr.map(item => item.replace(/[^a-zA-Z0-9]/g, '').toLowerCase());
        return cleanArr.filter(i => i).join(separator);
    }

    function updatePreview() {
        const title = document.getElementById('ep-title').value || 'untitled';
        const dateVal = document.getElementById('ep-date').value || '2025-01-01';
        const fileInput = document.getElementById('ep-file');
        
        let audioName = "æœªé€‰æ‹©æ–‡ä»¶";
        if (fileInput.files.length > 0) {
            const originalName = fileInput.files[0].name.replace(/\.mp3$/i, '');
            audioName = toPinyinString(originalName, '') + ".mp3";
        }
        const postName = `${dateVal}-${toPinyinString(title, '-')}.md`;

        document.getElementById('preview-audio').innerText = audioName;
        document.getElementById('preview-post').innerText = `_posts/${postName}`;
        return { audioName, postName };
    }

    function updateRSSUrlDisplay() {
        const url = document.getElementById('cfg-url').value.replace(/\/$/, '');
        let baseurl = document.getElementById('cfg-baseurl').value.trim();
        if (baseurl && !baseurl.startsWith('/')) baseurl = '/' + baseurl;
        baseurl = baseurl.replace(/\/$/, '');
        document.getElementById('final-rss-url').innerText = `${url}${baseurl}/podcast.rss`;
    }

    // --- æ–‡ä»¶ç³»ç»Ÿæ“ä½œ ---

    async function selectDirectory() {
        try {
            dirHandle = await window.showDirectoryPicker();
            try { await dirHandle.getFileHandle('_config.yml'); } 
            catch (e) { alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ° _config.ymlã€‚"); return; }

            document.getElementById('step-connect').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('ep-date').valueAsDate = new Date();
            
            await loadConfig();
            await loadRSS();
            await loadLogo();     // åŠ è½½ Logo
            await loadEpisodes(); // åŠ è½½èŠ‚ç›®åˆ—è¡¨

        } catch (err) { console.error(err); }
    }

    // --- Logo åŠŸèƒ½ ---
    async function loadLogo() {
        try {
            // å°è¯•è¯»å– assets/img/logo.png
            const assetsDir = await dirHandle.getDirectoryHandle('assets');
            const imgDir = await assetsDir.getDirectoryHandle('img');
            const fileHandle = await imgDir.getFileHandle('logo.png');
            const file = await fileHandle.getFile();
            const url = URL.createObjectURL(file);
            document.getElementById('current-logo').src = url;
        } catch (e) {
            console.log("æœªæ‰¾åˆ° Logo æˆ–è·¯å¾„ä¸å­˜åœ¨");
            document.getElementById('current-logo').alt = "æœªæ‰¾åˆ° assets/img/logo.png";
        }
    }

    async function handleLogoUpload() {
        const fileInput = document.getElementById('logo-upload');
        if (fileInput.files.length === 0) return;
        
        try {
            const file = fileInput.files[0];
            // ç¡®ä¿ç›®å½•å­˜åœ¨
            const assetsDir = await dirHandle.getDirectoryHandle('assets', { create: true });
            const imgDir = await assetsDir.getDirectoryHandle('img', { create: true });
            
            // å†™å…¥ logo.png (å¼ºåˆ¶é‡å‘½å)
            const fileHandle = await imgDir.getFileHandle('logo.png', { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(file);
            await writable.close();

            alert("Logo å·²æ›´æ–°ï¼");
            loadLogo(); // åˆ·æ–°æ˜¾ç¤º
        } catch (e) {
            alert("æ›´æ¢ Logo å¤±è´¥: " + e.message);
        }
    }

    // --- èŠ‚ç›®åˆ—è¡¨åŠŸèƒ½ ---
    async function loadEpisodes() {
        const listEl = document.getElementById('episode-list');
        listEl.innerHTML = '<li style="text-align: center; color: #999;">åŠ è½½ä¸­...</li>';
        
        try {
            const postsDir = await dirHandle.getDirectoryHandle('_posts');
            const episodes = [];

            // éå†æ–‡ä»¶
            for await (const entry of postsDir.values()) {
                if (entry.kind === 'file' && entry.name.endsWith('.md')) {
                    const file = await entry.getFile();
                    const text = await file.text();
                    
                    // ç®€å•çš„æ­£åˆ™æå– Title å’Œ Date
                    const titleMatch = text.match(/title:\s*"(.*?)"/);
                    const dateMatch = entry.name.match(/^(\d{4}-\d{2}-\d{2})/); // ä»æ–‡ä»¶åæå–æ—¥æœŸæœ€å‡†
                    
                    if (titleMatch) {
                        episodes.push({
                            title: titleMatch[1],
                            date: dateMatch ? dateMatch[1] : 'æœªçŸ¥æ—¥æœŸ',
                            filename: entry.name
                        });
                    }
                }
            }

            // æŒ‰æ—¥æœŸå€’åºæ’åº
            episodes.sort((a, b) => b.date.localeCompare(a.date));

            // æ¸²æŸ“åˆ—è¡¨
            listEl.innerHTML = '';
            if (episodes.length === 0) {
                listEl.innerHTML = '<li style="text-align: center;">æš‚æ— èŠ‚ç›®</li>';
            } else {
                episodes.forEach(ep => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="episode-date">${ep.date}</span>
                        <span class="episode-title">${ep.title}</span>
                    `;
                    listEl.appendChild(li);
                });
            }

        } catch (e) {
            console.error(e);
            listEl.innerHTML = '<li style="color: red;">è¯»å–åˆ—è¡¨å¤±è´¥</li>';
        }
    }

    // --- åŸºç¡€é…ç½®åŠŸèƒ½ ---
    async function loadConfig() {
        try {
            const fileHandle = await dirHandle.getFileHandle('_config.yml');
            const file = await fileHandle.getFile();
            const config = jsyaml.load(await file.text());
            document.getElementById('cfg-title').value = config.title || '';
            document.getElementById('cfg-url').value = config.url || '';
            document.getElementById('cfg-baseurl').value = config.baseurl || '';
            document.getElementById('cfg-desc').value = config.description || '';
            updateRSSUrlDisplay();
        } catch (e) { console.error(e); }
    }

    async function saveConfig() {
        try {
            const fileHandle = await dirHandle.getFileHandle('_config.yml', { create: false });
            const text = await (await fileHandle.getFile()).text();
            let config = jsyaml.load(text) || {};
            config.title = document.getElementById('cfg-title').value;
            config.url = document.getElementById('cfg-url').value;
            config.baseurl = document.getElementById('cfg-baseurl').value;
            config.description = document.getElementById('cfg-desc').value;
            const writable = await fileHandle.createWritable();
            await writable.write(jsyaml.dump(config));
            await writable.close();
            showMsg('cfg-msg', 'å·²ä¿å­˜!', 'green');
            updateRSSUrlDisplay();
        } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
    }

    async function loadRSS() {
        try {
            const fileHandle = await dirHandle.getFileHandle('podcast.rss');
            document.getElementById('rss-editor').value = await (await fileHandle.getFile()).text();
        } catch (e) { document.getElementById('rss-editor').value = "æœªæ‰¾åˆ° podcast.rss"; }
    }

    async function saveRSS() {
        try {
            const content = document.getElementById('rss-editor').value;
            const fileHandle = await dirHandle.getFileHandle('podcast.rss', { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
            showMsg('rss-msg', 'RSS å·²æ›´æ–°', 'green');
        } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
    }

    async function createEpisode() {
        const title = document.getElementById('ep-title').value;
        const fileInput = document.getElementById('ep-file');
        const desc = document.getElementById('ep-desc').value;
        const duration = document.getElementById('ep-duration').value;
        const explicit = document.getElementById('ep-explicit').value;
        const msgDiv = document.getElementById('ep-msg');

        if (!title || fileInput.files.length === 0) { alert("è¯·å¡«å†™å®Œæ•´"); return; }
        msgDiv.innerText = "å¤„ç†ä¸­..."; msgDiv.className = "status"; msgDiv.classList.remove('hidden');

        try {
            const audioFile = fileInput.files[0];
            const { audioName, postName } = updatePreview();

            // ä¿å­˜éŸ³é¢‘
            const assetsDir = await dirHandle.getDirectoryHandle('assets', { create: true });
            const audioDir = await assetsDir.getDirectoryHandle('audio', { create: true });
            const newAudioHandle = await audioDir.getFileHandle(audioName, { create: true });
            const writableAudio = await newAudioHandle.createWritable();
            await writableAudio.write(audioFile);
            await writableAudio.close();

            // ç”Ÿæˆ Markdown
            const postsDir = await dirHandle.getDirectoryHandle('_posts', { create: true });
            const fileSize = audioFile.size;
            const now = new Date();
            const dateVal = document.getElementById('ep-date').value;
            const timeStr = now.toTimeString().split(' ')[0];
            
            const playerCode = `
<audio controls preload="none" style="width: 100%; margin: 20px 0; background: #f1f3f4; border-radius: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
  <source src="{{ site.url }}{{ site.baseurl }}/assets/audio/${audioName}" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ’­æ”¾éŸ³é¢‘ï¼Œè¯·ä¸‹è½½æ–‡ä»¶æ’­æ”¾ã€‚
</audio>`;

            const mdContent = `---
layout: post
title: "${title}"
date: ${dateVal} ${timeStr} -0000
file: /assets/audio/${audioName}
summary: "${desc.substring(0, 100).replace(/\n/g, ' ').replace(/"/g, '\\"')}"
description: "${desc.replace(/"/g, '\\"')}"
duration: "${duration}"
length: "${fileSize}"
explicit: "${explicit}"
keywords: ""
block: "no"
voices: ""
---

${playerCode}

${desc}
`;
            
            const newPostHandle = await postsDir.getFileHandle(postName, { create: true });
            const writablePost = await newPostHandle.createWritable();
            await writablePost.write(mdContent);
            await writablePost.close();

            msgDiv.innerHTML = `<strong>âœ… æˆåŠŸï¼</strong><br>å·²ç”Ÿæˆ: ${postName}<br>è¯·å» GitHub Desktop æäº¤ã€‚`;
            msgDiv.className = "status success";
            
            // æˆåŠŸååˆ·æ–°åˆ—è¡¨
            loadEpisodes();

        } catch (e) {
            console.error(e);
            msgDiv.innerText = "é”™è¯¯: " + e.message;
            msgDiv.className = "status error";
        }
    }

    function showMsg(id, text, color) {
        const el = document.getElementById(id);
        el.innerText = text;
        el.style.color = color;
        setTimeout(() => el.innerText = "", 3000);
    }
</script>
</body>
</html>