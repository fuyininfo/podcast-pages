<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Pages ç®¡ç†æ§åˆ¶å° (Pro)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root { --primary: #2ea44f; --bg: #f6f8fa; --border: #d1d5da; --text: #24292e; --warning: #d29922; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        .header { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: start; }
        
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .side-column { order: -1; }
        }

        .card { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none; }
        
        h1 { margin: 0; }
        h2 { font-size: 1.2em; margin-top: 0; color: #0366d6; display: flex; align-items: center; justify-content: space-between; }
        h3 { font-size: 1em; margin: 0 0 10px 0; color: #586069; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        label { display: block; margin: 12px 0 6px; font-weight: 600; font-size: 0.9em; }
        p.hint { font-size: 0.85em; color: #586069; margin: 5px 0; }
        a { color: #0366d6; text-decoration: none; }
        a:hover { text-decoration: underline; }

        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea.code-editor { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 13px; background: #f6f8fa; min-height: 200px; }
        
        button { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #f3f4f6; color: #24292e; border: 1px solid rgba(27,31,35,0.15); }
        button.secondary:hover { background-color: #edeff2; }
        button.small { padding: 4px 8px; font-size: 12px; }
        button.cancel { background-color: #cf222e; }

        /* ç¼–è¾‘æ¨¡å¼é«˜äº® */
        .editing-mode { border: 2px solid var(--warning); position: relative; }
        .editing-badge { background: var(--warning); color: black; padding: 2px 8px; font-size: 12px; border-radius: 0 0 4px 4px; position: absolute; top: 0; right: 20px; font-weight: bold; }

        .status { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 0.9em; }
        .success { background: #dcffe4; color: #1a7f37; border: 1px solid #b4eebf; }
        .error { background: #ffe3e6; color: #cf222e; border: 1px solid #ffb3b8; }
        .info-box { background: #e1f5fe; padding: 15px; border-radius: 6px; border-left: 4px solid #03a9f4; margin-bottom: 20px; }
        .preview-box { background: #f1f8ff; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.85em; margin-top: 5px; color: #444; border: 1px solid #c8e1ff; }

        .side-column .logo-preview { width: 100%; max-width: 150px; display: block; margin: 10px auto; border-radius: 6px; border: 1px solid #eee; }
        .episode-list { list-style: none; padding: 0; max-height: 500px; overflow-y: auto; }
        .episode-list li { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: start; }
        .episode-info { font-size: 0.9em; }
        .episode-date { color: #586069; font-size: 0.85em; display: block; margin-bottom: 2px; }
        .episode-title { font-weight: 600; color: #24292e; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ™ï¸ Podcast Pages ç®¡ç†æ§åˆ¶å° (Pro)</h1>
    </div>

    <div id="step-connect" class="card">
        <h2>ğŸ“‚ ç¬¬ä¸€æ­¥ï¼šè¿æ¥é¡¹ç›®</h2>
        <p>è¯·ç‚¹å‡»æŒ‰é’®é€‰æ‹©æœ¬åœ°çš„ <code>podcast-pages</code> æ–‡ä»¶å¤¹ã€‚</p>
        <button onclick="selectDirectory()">æ‰“å¼€é¡¹ç›®æ–‡ä»¶å¤¹</button>
        <p id="dir-status" class="status hidden"></p>
    </div>

    <div id="main-interface" class="main-layout hidden">
        
        <div class="main-column">
            
            <div class="card">
                <h2>âš™ï¸ ç½‘ç«™åŸºç¡€è®¾ç½®</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>æ’­å®¢åç§°</label>
                        <input type="text" id="cfg-title">
                    </div>
                    <div>
                        <label>GitHub Pages é“¾æ¥</label>
                        <input type="text" id="cfg-url" placeholder="https://username.github.io">
                    </div>
                </div>
                <label>ä»“åº“åç§° (Baseurl)</label>
                <input type="text" id="cfg-baseurl" placeholder="/podcast-pages">
                <label>æ’­å®¢æè¿°</label>
                <textarea id="cfg-desc" rows="2"></textarea>
                <div style="margin-top:10px;">
                    <button class="secondary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <span id="cfg-msg" style="margin-left: 10px; font-size: 0.8em;"></span>
                </div>
            </div>

            <div id="editor-card" class="card" style="border-left: 4px solid var(--primary);">
                <div id="editing-badge" class="editing-badge hidden">âœï¸ æ­£åœ¨ç¼–è¾‘æ—§èŠ‚ç›®</div>
                <h2 id="editor-title">ğŸ†• å‘å¸ƒæ–°èŠ‚ç›®</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>èŠ‚ç›®æ ‡é¢˜</label>
                        <input type="text" id="ep-title" placeholder="ä¾‹å¦‚ï¼šç¬¬01æœŸ - èŠèŠæŠ€æœ¯">
                    </div>
                    <div>
                        <label>å‘å¸ƒæ—¥æœŸ</label>
                        <input type="date" id="ep-date">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>æ—¶é•¿</label>
                        <input type="text" id="ep-duration" placeholder="MM:SS">
                    </div>
                    <div>
                        <label>å†…å®¹åˆ†çº§</label>
                        <select id="ep-explicit">
                            <option value="no">No (å…¨å¹´é¾„)</option>
                            <option value="yes">Yes (é™åˆ¶çº§)</option>
                        </select>
                    </div>
                </div>

                <label>éŸ³é¢‘æ–‡ä»¶ (.mp3)</label>
                <p id="current-audio-display" class="hint hidden" style="color: #0366d6;">ğŸµ å½“å‰å·²å…³è”: <span id="current-audio-name"></span></p>
                <input type="file" id="ep-file" accept=".mp3">
                <p class="hint">å¦‚æœæ˜¯æ–°å»ºï¼Œè¯·ä¸Šä¼ æ–‡ä»¶ï¼›å¦‚æœæ˜¯ç¼–è¾‘ä¸”ä¸ä¿®æ”¹éŸ³é¢‘ï¼Œè¯·ç•™ç©ºã€‚</p>

                <label>èŠ‚ç›®ç®€ä»‹</label>
                <textarea id="ep-desc" rows="6" placeholder="æœ¬æœŸèŠ‚ç›®çš„è¯¦ç»†ä»‹ç»..."></textarea>

                <div class="preview-box">
                    <div>ğŸµ éŸ³é¢‘: <span id="preview-audio">-</span></div>
                    <div>ğŸ“„ é¡µé¢: <span id="preview-post">-</span></div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button id="btn-save" onclick="handleSave()">ğŸš€ ç”Ÿæˆ/ä¿å­˜èŠ‚ç›®</button>
                    <button id="btn-cancel" class="cancel hidden" onclick="exitEditMode()">å–æ¶ˆç¼–è¾‘</button>
                </div>
                <div id="ep-msg" class="status hidden"></div>
            </div>

            <div class="card">
                <h2><span>ğŸ“¡ RSS ä¸ åˆ†ç±»</span></h2>
                <textarea id="rss-editor" class="code-editor" spellcheck="false"></textarea>
                <div style="margin-top: 10px;">
                    <button class="secondary" onclick="saveRSS()">ğŸ’¾ ä¿å­˜ RSS</button>
                    <span id="rss-msg" style="margin-left: 10px; font-size: 0.8em;"></span>
                </div>
                <div style="margin-top: 15px;">
                    <label>RSS è®¢é˜…é“¾æ¥:</label>
                    <div id="final-rss-url" class="rss-link-box">...</div>
                </div>
            </div>
            
            <div class="info-box">
                <h2>ğŸ“¤ åŒæ­¥æŒ‡å—</h2>
                <p>æ–‡ä»¶ç”Ÿæˆåï¼Œè¯·æ‰“å¼€ <strong>GitHub Desktop</strong>ï¼š</p>
                <ol>
                    <li>æ£€æŸ¥å·¦ä¾§ Changes åˆ—è¡¨ï¼Œç¡®è®¤æœ‰æ–°çš„ <code>.mp3</code> å’Œ <code>.md</code> æ–‡ä»¶ã€‚</li>
                    <li>åœ¨ Summary æ¡†è¾“å…¥å¤‡æ³¨ï¼ˆå¦‚â€œå‘å¸ƒæ–°èŠ‚ç›®â€ï¼‰ã€‚</li>
                    <li>ç‚¹å‡» <strong>Commit to master</strong>ã€‚</li>
                    <li>ç‚¹å‡»é¡¶éƒ¨ <strong>Push origin</strong>ã€‚</li>
                    <li>ç­‰å¾… 1-2 åˆ†é’Ÿï¼ŒRSS å³å¯è‡ªåŠ¨æ›´æ–°ã€‚</li>
                </ol>
            </div>

        </div>

        <div class="side-column">
            <div class="card" style="text-align: center;">
                <h3>ğŸ–¼ï¸ æ’­å®¢ Logo</h3>
                <img id="current-logo" src="" alt="æš‚æ—  Logo" class="logo-preview">
                <input type="file" id="logo-upload" accept="image/png, image/jpeg" style="display: none;" onchange="handleLogoUpload()">
                <button class="secondary small" onclick="document.getElementById('logo-upload').click()">ğŸ“‚ æ›´æ¢ Logo</button>
                <p class="hint">å»ºè®® 1400x1400 åƒç´ ï¼Œpng/jpg</p>
            </div>

            <div class="card">
                <h3>ğŸ“‹ å·²å‘å¸ƒèŠ‚ç›®</h3>
                <ul id="episode-list" class="episode-list">
                    <li style="text-align: center; color: #999;">æ­£åœ¨åŠ è½½...</li>
                </ul>
                <div style="margin-top: 10px; text-align: center;">
                    <button class="secondary small" onclick="loadEpisodes()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>
            </div>
        </div>
    </div>

<script>
    let dirHandle;
    let editingFilename = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶å
    let originalAudioPath = null; // ç¼–è¾‘æ—¶ä¿ç•™çš„æ—§éŸ³é¢‘è·¯å¾„
    const { pinyin } = pinyinPro;

    // --- ç•Œé¢ç›‘å¬ ---
    document.getElementById('ep-title').addEventListener('input', updatePreview);
    document.getElementById('ep-date').addEventListener('change', updatePreview);
    document.getElementById('ep-file').addEventListener('change', updatePreview);

    function toPinyinString(str, separator = '') {
        const pinyinArr = pinyin(str, { toneType: 'none', type: 'array', nonZh: 'consecutive' });
        const cleanArr = pinyinArr.map(item => item.replace(/[^a-zA-Z0-9]/g, '').toLowerCase());
        return cleanArr.filter(i => i).join(separator);
    }

    function updatePreview() {
        const title = document.getElementById('ep-title').value || 'untitled';
        const dateVal = document.getElementById('ep-date').value || '2025-01-01';
        const fileInput = document.getElementById('ep-file');
        
        let audioName = "æœªé€‰æ‹©æ–‡ä»¶";
        // é€»è¾‘ï¼šå¦‚æœæœ‰æ–°ä¸Šä¼ ï¼Œæ˜¾ç¤ºæ–°æ–‡ä»¶åï¼›å¦‚æœæ²¡æœ‰ä½†æœ‰æ—§éŸ³é¢‘ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰ï¼Œæ˜¾ç¤ºæ—§éŸ³é¢‘ï¼›å¦åˆ™æ˜¾ç¤ºæœªé€‰æ‹©
        if (fileInput.files.length > 0) {
            const originalName = fileInput.files[0].name.replace(/\.mp3$/i, '');
            audioName = toPinyinString(originalName, '') + ".mp3";
        } else if (editingFilename && originalAudioPath) {
            // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶å
            audioName = originalAudioPath.split('/').pop() + " (ä¿æŒä¸å˜)";
        }
        
        const postName = `${dateVal}-${toPinyinString(title, '-')}.md`;

        document.getElementById('preview-audio').innerText = audioName;
        document.getElementById('preview-post').innerText = `_posts/${postName}`;
        return { audioName, postName };
    }

    function updateRSSUrlDisplay() {
        const url = document.getElementById('cfg-url').value.replace(/\/$/, '');
        let baseurl = document.getElementById('cfg-baseurl').value.trim();
        if (baseurl && !baseurl.startsWith('/')) baseurl = '/' + baseurl;
        baseurl = baseurl.replace(/\/$/, '');
        document.getElementById('final-rss-url').innerText = `${url}${baseurl}/podcast.rss`;
    }

    // --- æ ¸å¿ƒï¼šè¿›å…¥ç¼–è¾‘æ¨¡å¼ ---
    async function editEpisode(filename) {
        try {
            const postsDir = await dirHandle.getDirectoryHandle('_posts');
            const fileHandle = await postsDir.getFileHandle(filename);
            const file = await fileHandle.getFile();
            const text = await file.text();

            // è§£æ Front Matter
            const yamlMatch = text.match(/^---\n([\s\S]*?)\n---/);
            if (!yamlMatch) throw new Error("æ— æ³•è§£ææ–‡ä»¶æ ¼å¼");

            const config = jsyaml.load(yamlMatch[1]);
            
            // å¡«å……è¡¨å•
            document.getElementById('ep-title').value = config.title || '';
            
            // æ—¥æœŸå¤„ç†
            let dateStr = '';
            if (config.date) {
                // å¦‚æœ config.date æ˜¯ Date å¯¹è±¡
                if (config.date instanceof Date) {
                    dateStr = config.date.toISOString().split('T')[0];
                } else {
                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²
                    dateStr = String(config.date).split(' ')[0];
                }
            } else {
                // å¦‚æœ yaml é‡Œæ²¡æ—¥æœŸï¼Œä»æ–‡ä»¶åæå–
                const nameMatch = filename.match(/^(\d{4}-\d{2}-\d{2})/);
                dateStr = nameMatch ? nameMatch[1] : new Date().toISOString().split('T')[0];
            }
            document.getElementById('ep-date').value = dateStr;
            
            document.getElementById('ep-duration').value = config.duration || '';
            document.getElementById('ep-explicit').value = config.explicit || 'no';
            document.getElementById('ep-desc').value = config.description || '';

            // è®¾ç½®çŠ¶æ€
            editingFilename = filename;
            originalAudioPath = config.file || '';

            // UI å˜æ›´
            document.getElementById('editor-card').classList.add('editing-mode');
            document.getElementById('editing-badge').classList.remove('hidden');
            document.getElementById('editor-title').innerText = "âœï¸ ç¼–è¾‘èŠ‚ç›®";
            document.getElementById('btn-save').innerText = "ğŸ’¾ ä¿å­˜ä¿®æ”¹";
            document.getElementById('btn-cancel').classList.remove('hidden');
            
            if (originalAudioPath) {
                document.getElementById('current-audio-display').classList.remove('hidden');
                document.getElementById('current-audio-name').innerText = originalAudioPath;
            }

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            document.getElementById('editor-card').scrollIntoView({ behavior: 'smooth' });
            updatePreview();

        } catch (e) {
            console.error(e);
            alert("è¯»å–æ–‡ä»¶å¤±è´¥: " + e.message);
        }
    }

    function exitEditMode() {
        editingFilename = null;
        originalAudioPath = null;
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('ep-title').value = '';
        document.getElementById('ep-date').valueAsDate = new Date();
        document.getElementById('ep-duration').value = '';
        document.getElementById('ep-desc').value = '';
        document.getElementById('ep-file').value = '';

        // UI æ¢å¤
        document.getElementById('editor-card').classList.remove('editing-mode');
        document.getElementById('editing-badge').classList.add('hidden');
        document.getElementById('editor-title').innerText = "ğŸ†• å‘å¸ƒæ–°èŠ‚ç›®";
        document.getElementById('btn-save').innerText = "ğŸš€ ç”Ÿæˆ/ä¿å­˜èŠ‚ç›®";
        document.getElementById('btn-cancel').classList.add('hidden');
        document.getElementById('current-audio-display').classList.add('hidden');
        document.getElementById('ep-msg').classList.add('hidden');
        
        updatePreview();
    }

    // --- æ ¸å¿ƒï¼šä¿å­˜/åˆ›å»ºé€»è¾‘ ---
    async function handleSave() {
        const title = document.getElementById('ep-title').value;
        const fileInput = document.getElementById('ep-file');
        const desc = document.getElementById('ep-desc').value;
        const duration = document.getElementById('ep-duration').value;
        const explicit = document.getElementById('ep-explicit').value;
        const msgDiv = document.getElementById('ep-msg');

        if (!title) { alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©º"); return; }
        
        // æ£€æŸ¥éŸ³é¢‘ï¼šæ–°å»ºæ¨¡å¼å¿…é¡»æœ‰æ–‡ä»¶ï¼›ç¼–è¾‘æ¨¡å¼å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œå¿…é¡»æœ‰æ—§è·¯å¾„
        if (!editingFilename && fileInput.files.length === 0) {
            alert("æ–°å»ºèŠ‚ç›®å¿…é¡»ä¸Šä¼  MP3 æ–‡ä»¶"); return;
        }

        msgDiv.innerText = "æ­£åœ¨å¤„ç†..."; msgDiv.className = "status"; msgDiv.classList.remove('hidden');

        try {
            const { audioName, postName } = updatePreview();
            let finalAudioPath = originalAudioPath;

            // 1. å¤„ç†éŸ³é¢‘ (å¦‚æœæœ‰æ–°ä¸Šä¼ )
            if (fileInput.files.length > 0) {
                const assetsDir = await dirHandle.getDirectoryHandle('assets', { create: true });
                const audioDir = await assetsDir.getDirectoryHandle('audio', { create: true });
                const newAudioHandle = await audioDir.getFileHandle(audioName, { create: true });
                const writableAudio = await newAudioHandle.createWritable();
                await writableAudio.write(fileInput.files[0]);
                await writableAudio.close();
                finalAudioPath = `/assets/audio/${audioName}`;
            } else {
                // æ²¡æœ‰ä¸Šä¼ ï¼Œå¿…é¡»ç¡®ä¿æœ‰æ—§è·¯å¾„ (ç»™ç¼–è¾‘æ¨¡å¼ç”¨çš„)
                if (!finalAudioPath) throw new Error("éŸ³é¢‘æ–‡ä»¶ä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ ");
            }
            
            // ç¡®ä¿éŸ³é¢‘è·¯å¾„æ ‡å‡†åŒ–
            if (!finalAudioPath.startsWith('/')) finalAudioPath = '/' + finalAudioPath.replace(/^[\/]?/, '');

            // 2. ç”Ÿæˆ Markdown å†…å®¹
            const postsDir = await dirHandle.getDirectoryHandle('_posts', { create: true });
            
            // å°è¯•è·å–æ–‡ä»¶å¤§å°
            let fileSize = "0";
            if (fileInput.files.length > 0) {
                fileSize = fileInput.files[0].size;
            } else {
                // å¦‚æœæ²¡ä¼ æ–°æ–‡ä»¶ï¼Œå°½é‡ä¸è¦†ç›–æ—§çš„ length (è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå¦‚æœèƒ½è¯»åˆ°æ—§ yaml çš„ length æœ€å¥½ï¼Œç›®å‰æš‚å¡«0æˆ–ä¿ç•™æ—§å€¼éœ€æ›´å¤æ‚é€»è¾‘)
                // ç®€å•èµ·è§ï¼Œå¦‚æœæ²¡ä¼ æ–‡ä»¶ï¼Œå¤§å°å¡« "0" æˆ–è®¸ä¼šå½±å“ RSSï¼Œä½†é€šå¸¸æ’­æ”¾å™¨åªçœ‹ URLã€‚
                // å®Œç¾æ–¹æ¡ˆæ˜¯åœ¨ editEpisode è¯»å–æ—¶æŠŠ length ä¹Ÿè¯»å‡ºæ¥å­˜åˆ°å…¨å±€å˜é‡ã€‚
                // è¿™é‡Œä¸ºäº†ç¨³å¦¥ï¼Œæš‚ä¸å¼ºæ±‚æ—§å¤§å°ï¼Œé€šå¸¸ RSS é˜…è¯»å™¨èƒ½è‡ªå·±æ¢æµ‹ã€‚
            }
            
            const now = new Date();
            const dateVal = document.getElementById('ep-date').value;
            const timeStr = now.toTimeString().split(' ')[0];
            
            // æ’­æ”¾å™¨ä»£ç 
            const actualAudioName = finalAudioPath.split('/').pop();
            const playerCode = `
<audio controls preload="none" style="width: 100%; margin: 20px 0; background: #f1f3f4; border-radius: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
  <source src="{{ site.url }}{{ site.baseurl }}/assets/audio/${actualAudioName}" type="audio/mpeg">
  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ’­æ”¾éŸ³é¢‘ï¼Œè¯·ä¸‹è½½æ–‡ä»¶æ’­æ”¾ã€‚
</audio>`;

            const mdContent = `---
layout: post
title: "${title}"
date: ${dateVal} ${timeStr} -0000
file: ${finalAudioPath}
summary: "${desc.substring(0, 100).replace(/\n/g, ' ').replace(/"/g, '\\"')}"
description: "${desc.replace(/"/g, '\\"')}"
duration: "${duration}"
length: "${fileSize}"
explicit: "${explicit}"
keywords: ""
block: "no"
voices: ""
---

${playerCode}

${desc}
`;
            
            // 3. å†™å…¥æ–°æ–‡ä»¶
            const newPostHandle = await postsDir.getFileHandle(postName, { create: true });
            const writablePost = await newPostHandle.createWritable();
            await writablePost.write(mdContent);
            await writablePost.close();

            // 4. å¤„ç†é‡å‘½å (å¦‚æœæ˜¯åœ¨ç¼–è¾‘ï¼Œä¸”æ–‡ä»¶åå˜äº†)
            if (editingFilename && editingFilename !== postName) {
                // åˆ é™¤æ—§æ–‡ä»¶
                await postsDir.removeEntry(editingFilename);
                msgDiv.innerHTML = `<strong>âœ… æ›´æ–°å¹¶é‡å‘½åæˆåŠŸï¼</strong><br>æ—§æ–‡ä»¶å·²åˆ é™¤: ${editingFilename}<br>æ–°æ–‡ä»¶: ${postName}`;
            } else {
                msgDiv.innerHTML = `<strong>âœ… ä¿å­˜æˆåŠŸï¼</strong><br>æ–‡ä»¶: ${postName}`;
            }
            
            msgDiv.className = "status success";
            
            // åˆ·æ–°åˆ—è¡¨å¹¶é€€å‡ºç¼–è¾‘æ¨¡å¼
            await loadEpisodes();
            // å»¶è¿Ÿä¸€ç‚¹é€€å‡ºï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
            setTimeout(() => {
                exitEditMode();
                msgDiv.innerText = "æ“ä½œå®Œæˆï¼Œå·²é‡ç½®è¡¨å•ã€‚";
                msgDiv.classList.remove('hidden');
            }, 1500);

        } catch (e) {
            console.error(e);
            msgDiv.innerText = "é”™è¯¯: " + e.message;
            msgDiv.className = "status error";
        }
    }

    // --- æ–‡ä»¶ç³»ç»ŸåŸºç¡€ ---
    async function selectDirectory() {
        try {
            dirHandle = await window.showDirectoryPicker();
            try { await dirHandle.getFileHandle('_config.yml'); } catch (e) { alert("æ‰¾ä¸åˆ° _config.yml"); return; }
            document.getElementById('step-connect').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            document.getElementById('ep-date').valueAsDate = new Date();
            
            await loadConfig();
            await loadRSS();
            await loadLogo();
            await loadEpisodes();
        } catch (err) { console.error(err); }
    }

    // --- åˆ—è¡¨åŠ è½½ ---
    async function loadEpisodes() {
        const listEl = document.getElementById('episode-list');
        listEl.innerHTML = '<li style="text-align: center; color: #999;">åŠ è½½ä¸­...</li>';
        try {
            const postsDir = await dirHandle.getDirectoryHandle('_posts');
            const episodes = [];
            for await (const entry of postsDir.values()) {
                if (entry.kind === 'file' && entry.name.endsWith('.md')) {
                    const file = await entry.getFile();
                    const text = await file.text();
                    const titleMatch = text.match(/title:\s*"(.*?)"/);
                    const dateMatch = entry.name.match(/^(\d{4}-\d{2}-\d{2})/);
                    if (titleMatch) {
                        episodes.push({
                            title: titleMatch[1],
                            date: dateMatch ? dateMatch[1] : 'æœªçŸ¥',
                            filename: entry.name
                        });
                    }
                }
            }
            episodes.sort((a, b) => b.date.localeCompare(a.date));
            listEl.innerHTML = '';
            if (episodes.length === 0) listEl.innerHTML = '<li style="text-align: center;">æš‚æ— èŠ‚ç›®</li>';
            else {
                episodes.forEach(ep => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="episode-info">
                            <span class="episode-date">${ep.date}</span>
                            <span class="episode-title">${ep.title}</span>
                        </div>
                        <button class="secondary small" onclick="editEpisode('${ep.filename}')">âœï¸ ç¼–è¾‘</button>
                    `;
                    listEl.appendChild(li);
                });
            }
        } catch (e) { console.error(e); }
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---
    async function loadLogo() { 
        try {
            const assetsDir = await dirHandle.getDirectoryHandle('assets');
            const imgDir = await assetsDir.getDirectoryHandle('img');
            const fileHandle = await imgDir.getFileHandle('logo.png');
            const file = await fileHandle.getFile();
            document.getElementById('current-logo').src = URL.createObjectURL(file);
        } catch (e) { console.log(e); }
    }
    async function handleLogoUpload() { 
        const fileInput = document.getElementById('logo-upload');
        if (fileInput.files.length === 0) return;
        try {
            const assetsDir = await dirHandle.getDirectoryHandle('assets', {create:true});
            const imgDir = await assetsDir.getDirectoryHandle('img', {create:true});
            const fileHandle = await imgDir.getFileHandle('logo.png', {create:true});
            const writable = await fileHandle.createWritable();
            await writable.write(fileInput.files[0]);
            await writable.close();
            alert("Logo å·²æ›´æ–°"); loadLogo();
        } catch(e) { alert("Logoæ›´æ–°å¤±è´¥"); }
    }
    async function loadConfig() { 
        const fileHandle = await dirHandle.getFileHandle('_config.yml');
        const config = jsyaml.load(await (await fileHandle.getFile()).text());
        document.getElementById('cfg-title').value = config.title || '';
        document.getElementById('cfg-url').value = config.url || '';
        document.getElementById('cfg-baseurl').value = config.baseurl || '';
        document.getElementById('cfg-desc').value = config.description || '';
        updateRSSUrlDisplay();
    }
    async function saveConfig() { 
        const fileHandle = await dirHandle.getFileHandle('_config.yml', {create:false});
        const text = await (await fileHandle.getFile()).text();
        let config = jsyaml.load(text) || {};
        config.title = document.getElementById('cfg-title').value;
        config.url = document.getElementById('cfg-url').value;
        config.baseurl = document.getElementById('cfg-baseurl').value;
        config.description = document.getElementById('cfg-desc').value;
        const writable = await fileHandle.createWritable();
        await writable.write(jsyaml.dump(config));
        await writable.close();
        alert("é…ç½®å·²ä¿å­˜");
    }
    async function loadRSS() { 
        try {
            const fileHandle = await dirHandle.getFileHandle('podcast.rss');
            document.getElementById('rss-editor').value = await (await fileHandle.getFile()).text();
        } catch(e){}
    }
    async function saveRSS() { 
        try {
            const content = document.getElementById('rss-editor').value;
            const fileHandle = await dirHandle.getFileHandle('podcast.rss', {create:true});
            const writable = await fileHandle.createWritable();
            await writable.write(content);
            await writable.close();
            alert("RSS å·²ä¿å­˜");
        } catch(e) { alert("RSSä¿å­˜å¤±è´¥"); }
    }
</script>
</body>
</html>